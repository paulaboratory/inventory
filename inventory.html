<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory App - Neumorphic with History & Persistence</title>
  <!-- Include LZ-String library from CDN for compression in sharing liked list -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <style>
    /* ---------- BASE COLOR SCHEME ---------- */
    :root {
      --light-bg: #e0f7fa;      /* light cyan background */
      --dark-text: #0d47a1;     /* dark blue text */
      --card-bg: #ffffff;       /* card background */
      --accent: #b2ebf2;        /* accent color for buttons */
      --accent-hover: #80deea;  /* hover color for buttons */
    }
    /* ---------- NEUMORPHIC BASE STYLES ---------- */
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--light-bg);
      color: var(--dark-text);
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 30px;
      border-radius: 20px;
      background: var(--light-bg);
      box-shadow: 8px 8px 16px rgba(0,0,0,0.15),
                  -8px -8px 16px rgba(255,255,255,0.7);
    }
    /* ---------- HEADER ---------- */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.8em;
    }
    .header-icons {
      display: flex;
      gap: 15px;
    }
    .header-icons button {
      background: var(--light-bg);
      border: none;
      font-size: 1.8em;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
      transition: all 0.2s ease-in-out;
    }
    .header-icons button:hover {
      transform: translateY(-2px);
      box-shadow: 2px 2px 4px rgba(0,0,0,0.15),
                  -2px -2px 4px rgba(255,255,255,0.7);
    }
    .header-icons input {
      display: none;
    }
    /* ---------- TABS ---------- */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--accent);
      margin-bottom: 20px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      background: var(--light-bg);
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
    }
    .tab.active {
      background: var(--card-bg);
      border-bottom: 3px solid var(--dark-text);
    }
    .tab:hover {
      background: var(--card-bg);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* ---------- CONTROL PANEL ---------- */
    .control-panel {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .control-panel input[type="text"],
    .control-panel select {
      padding: 10px;
      border: none;
      border-radius: 12px;
      background: var(--light-bg);
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.15),
                  inset -4px -4px 8px rgba(255,255,255,0.7);
      flex: 1;
      min-width: 150px;
    }
    .control-panel .view-toggle button {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
      transition: background 0.3s ease;
    }
    .control-panel .view-toggle button.active {
      background: var(--accent-hover);
    }
    .control-panel .view-toggle button:hover {
      background: var(--accent-hover);
    }
    /* ---------- INVENTORY CARDS ---------- */
    #inventory-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    .inventory-card {
      position: relative;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.15),
                  -8px -8px 16px rgba(255,255,255,0.7);
      transition: transform 0.2s ease;
    }
    .inventory-card:hover {
      transform: translateY(-4px);
    }
    .inventory-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .inventory-card h3 {
      margin: 0;
      font-size: 1.2em;
    }
    .inventory-card p {
      margin: 8px 0;
    }
    .card-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
    }
    .card-actions button {
      background: var(--light-bg);
      border: none;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 12px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
      transition: transform 0.2s ease;
    }
    .card-actions button:hover {
      transform: translateY(-2px);
    }
    /* ---------- LIST VIEW ---------- */
    .list-view .item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      background: var(--card-bg);
      margin-bottom: 10px;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
    }
    .list-view .item-row:last-child {
      margin-bottom: 0;
    }
    /* ---------- FORMS ---------- */
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: var(--light-bg);
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.15),
                  inset -4px -4px 8px rgba(255,255,255,0.7);
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: var(--dark-text);
      padding: 12px;
      transition: background 0.3s ease;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
    }
    button:hover {
      background: var(--accent-hover);
    }
    /* ---------- CATEGORY TABS ---------- */
    .sub-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .category-tab {
      padding: 10px 16px;
      border: 1px solid var(--dark-text);
      border-radius: 12px;
      cursor: pointer;
      background: var(--light-bg);
      transition: background 0.3s ease;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.15),
                  -4px -4px 8px rgba(255,255,255,0.7);
    }
    .category-tab.active {
      background: var(--dark-text);
      color: #fff;
    }
    /* ---------- HISTORY LOG ---------- */
    #history-log {
      max-height: 200px;
      overflow-y: auto;
      background: var(--light-bg);
      padding: 10px;
      border-radius: 12px;
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.15),
                  inset -4px -4px 8px rgba(255,255,255,0.7);
    }
    #history-log p {
      margin: 4px 0;
      font-size: 0.9em;
    }
    /* ---------- MODALS ---------- */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.15),
                  -8px -8px 16px rgba(255,255,255,0.7);
    }
    .modal-content h2 {
      margin-top: 0;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    /* ---------- DARK MODE ---------- */
    .night-mode body {
      background: #121212;
      color: #e0e0e0;
    }
    .night-mode .container {
      background: #1e1e1e;
      box-shadow: none;
    }
    .night-mode h1, .night-mode h2, .night-mode label {
      color: #e0e0e0;
    }
    .night-mode .inventory-card, .night-mode .modal-content {
      background: #1e1e1e;
      box-shadow: none;
    }
    .night-mode button {
      background: #bb86fc;
      color: #121212;
      box-shadow: 4px 4px 8px rgba(0,0,0,0.4);
    }
    .night-mode button:hover {
      background: #985eff;
    }
    .night-mode .category-tab.active {
      background: #bb86fc;
      color: #121212;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Inventory App</h1>
      <div class="header-icons">
        <button id="btn-save-backup" title="Save Backup">ðŸ’¾</button>
        <button id="btn-load-backup" title="Load Backup">ðŸ“‚</button>
        <button id="btn-share" title="Share Inventory">ðŸ”—</button>
        <button id="nightModeToggle" title="Toggle Dark Mode">ðŸŒ™</button>
        <input type="file" id="backup-file" accept=".json" style="display: none;">
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div id="tab-inventory" class="tab active">Inventory</div>
      <div id="tab-inout" class="tab">In/Out Items</div>
      <div id="tab-new" class="tab">New Item</div>
      <div id="tab-liked" class="tab">Liked</div>
    </div>

    <!-- Inventory Tab -->
    <div id="content-inventory" class="tab-content active">
      <h2>Inventory</h2>
      <!-- Control Panel -->
      <div class="control-panel">
        <input type="text" id="inventory-search" placeholder="Search items...">
        <select id="inventory-sort">
          <option value="name_asc">Sort by Name (A-Z)</option>
          <option value="name_desc">Sort by Name (Z-A)</option>
          <option value="qty_asc">Sort by Quantity (Ascending)</option>
          <option value="qty_desc">Sort by Quantity (Descending)</option>
        </select>
        <div class="view-toggle">
          <button id="inventory-view-cards" class="active">Cards</button>
          <button id="inventory-view-list">List</button>
        </div>
      </div>
      <button id="btn-export-inventory" class="export-btn">Export Inventory</button>
      <div class="sub-tabs" id="category-tabs"></div>
      <div id="inventory-list"></div>
    </div>

    <!-- In/Out Items Tab -->
    <div id="content-inout" class="tab-content">
      <h2>In/Out Items</h2>
      <div class="form-group">
        <label for="inout-category">Select Category:</label>
        <select id="inout-category"></select>
      </div>
      <div class="form-group">
        <label for="inout-item">Select Item:</label>
        <select id="inout-item"></select>
      </div>
      <div class="form-group">
        <label for="inout-qty">Quantity:</label>
        <input type="number" id="inout-qty" value="1" min="1">
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="btn-add">Add</button>
        <button id="btn-remove">Remove</button>
      </div>
      <!-- History Log Section -->
      <h3>History Log</h3>
      <div id="history-log"></div>
    </div>

    <!-- New Item Tab -->
    <div id="content-new" class="tab-content">
      <h2>New Item</h2>
      <div class="form-group custom-dropdown">
        <label for="new-name">Item Name:</label>
        <input type="text" id="new-name" autocomplete="off">
        <div id="name-suggestions" class="suggestions"></div>
      </div>
      <div class="form-group custom-dropdown">
        <label for="new-category">Category:</label>
        <input type="text" id="new-category" autocomplete="off">
        <div id="category-suggestions" class="suggestions"></div>
      </div>
      <div class="form-group">
        <label for="new-qty">Quantity:</label>
        <input type="number" id="new-qty" value="1" min="1">
      </div>
      <div class="form-group">
        <label for="new-image">Upload Image:</label>
        <input type="file" id="new-image" accept="image/*">
      </div>
      <button id="btn-new-add">Add New Item</button>
    </div>

    <!-- Liked Tab -->
    <div id="content-liked" class="tab-content">
      <h2>Liked</h2>
      <div class="control-panel">
        <div class="view-toggle">
          <button id="liked-view-cards" class="active">Cards</button>
          <button id="liked-view-list">List</button>
        </div>
      </div>
      <button id="btn-export-liked" class="export-btn">Export Liked</button>
      <button id="btn-share-liked">Share Liked</button>
      <div id="liked-list"></div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <h2>Confirm Removal</h2>
      <p id="confirm-message">Are you sure you want to remove this item?</p>
      <div class="modal-buttons">
        <button id="confirm-ok">OK</button>
        <button id="confirm-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <h2>Edit Item</h2>
      <div class="form-group">
        <label for="edit-name">Item Name:</label>
        <input type="text" id="edit-name">
      </div>
      <div class="form-group">
        <label for="edit-category">Category:</label>
        <input type="text" id="edit-category">
      </div>
      <div class="modal-buttons">
        <button id="edit-save">Save</button>
        <button id="edit-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // GLOBAL VARIABLES
    let inventory = [];
    let liked = [];
    let historyLog = [];
    let nextId = 1;
    let activeCategoryTab = "All";
    let currentRemoveId = null;
    let currentEditId = null;
    let sharedMode = false; // true for shared view

    // Controls for Inventory & Liked
    let inventorySearchTerm = "";
    let inventorySortOption = "name_asc";
    let inventoryViewType = "cards";
    let likedViewType = "cards";

    /* DOM REFERENCES */
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    const categoryTabsDiv = document.getElementById('category-tabs');
    const inventoryListDiv = document.getElementById('inventory-list');
    const inoutCategorySelect = document.getElementById('inout-category');
    const inoutItemSelect = document.getElementById('inout-item');
    const inoutQty = document.getElementById('inout-qty');
    const btnAdd = document.getElementById('btn-add');
    const btnRemove = document.getElementById('btn-remove');
    const newNameInput = document.getElementById('new-name');
    const nameSuggestionsDiv = document.getElementById('name-suggestions');
    const newCategoryInput = document.getElementById('new-category');
    const categorySuggestionsDiv = document.getElementById('category-suggestions');
    const newQtyInput = document.getElementById('new-qty');
    const newImageInput = document.getElementById('new-image');
    const btnNewAdd = document.getElementById('btn-new-add');
    const likedListDiv = document.getElementById('liked-list');
    const btnExportInventory = document.getElementById('btn-export-inventory');
    const btnExportLiked = document.getElementById('btn-export-liked');
    const btnShareLiked = document.getElementById('btn-share-liked');

    // Control Panel Elements for Inventory
    const inventorySearchInput = document.getElementById('inventory-search');
    const inventorySortSelect = document.getElementById('inventory-sort');
    const inventoryViewCardsBtn = document.getElementById('inventory-view-cards');
    const inventoryViewListBtn = document.getElementById('inventory-view-list');
    // Liked Tab view toggle
    const likedViewCardsBtn = document.getElementById('liked-view-cards');
    const likedViewListBtn = document.getElementById('liked-view-list');

    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');
    const editModal = document.getElementById('edit-modal');
    const editName = document.getElementById('edit-name');
    const editCategory = document.getElementById('edit-category');
    const editSave = document.getElementById('edit-save');
    const editCancel = document.getElementById('edit-cancel');

    /* LOCAL STORAGE FUNCTIONS */
    function saveData() {
      const appData = {
        inventory: inventory,
        liked: liked,
        historyLog: historyLog
      };
      localStorage.setItem("appData", JSON.stringify(appData));
    }
    function loadData() {
      const data = localStorage.getItem("appData");
      if (data) {
        try {
          const appData = JSON.parse(data);
          if (appData.inventory) {
            inventory = appData.inventory;
            nextId = inventory.reduce((max, item) => Math.max(max, item.id), 0) + 1;
          }
          if (appData.liked) {
            liked = appData.liked;
          }
          if (appData.historyLog) {
            historyLog = appData.historyLog;
            updateHistoryDisplay();
          }
        } catch (err) {
          console.error("Error loading app data:", err);
        }
      }
    }

    /* HISTORY LOG FUNCTIONS */
    function logEvent(message) {
      const timestamp = new Date().toLocaleString();
      historyLog.push(`${timestamp}: ${message}`);
      updateHistoryDisplay();
      saveData();
    }
    function updateHistoryDisplay() {
      const historyDiv = document.getElementById("history-log");
      if (historyDiv) {
        historyDiv.innerHTML = "";
        historyLog.forEach(log => {
          const p = document.createElement("p");
          p.textContent = log;
          historyDiv.appendChild(p);
        });
      }
    }

    /* HEADER BUTTONS - Set up Once */
    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      const btnSaveBackup = document.getElementById('btn-save-backup');
      const btnLoadBackup = document.getElementById('btn-load-backup');
      const btnShare = document.getElementById('btn-share');
      const nightModeToggle = document.getElementById('nightModeToggle');
      const backupFileInput = document.getElementById('backup-file');

      btnSaveBackup.addEventListener("click", () => {
        // When saving backup, exclude the backup image data
        const backupInventory = inventory.map(({ backup, ...rest }) => rest);
        const appData = {
          inventory: backupInventory,
          liked: liked,
          historyLog: historyLog
        };
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "inventory_backup.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      btnLoadBackup.addEventListener("click", () => {
        backupFileInput.click();
      });
      backupFileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const appData = JSON.parse(e.target.result);
            if (appData.inventory && Array.isArray(appData.inventory)) {
              inventory = appData.inventory;
              nextId = inventory.reduce((max, item) => Math.max(max, item.id), 0) + 1;
            }
            if (appData.liked) {
              liked = appData.liked;
            }
            if (appData.historyLog) {
              historyLog = appData.historyLog;
              updateHistoryDisplay();
            }
            renderCategoryTabs();
            updateInventoryDisplay();
            updateInOutCategories();
            updateInOutItems();
            saveData();
          } catch (err) {
            alert("Error reading backup file.");
          }
        };
        reader.readAsText(file);
      });

  btnShare.addEventListener("click", () => {
  // Create a shareable version of inventory without the backup property
  const shareInventory = inventory.map(({ backup, ...rest }) => rest);
  const dataStr = JSON.stringify(shareInventory);
  // Compress the JSON data
  const compressed = LZString.compressToEncodedURIComponent(dataStr);
  const shareableLink = window.location.origin + window.location.pathname + "?data=" + compressed;
  navigator.clipboard.writeText(shareableLink)
    .then(() => alert("Shareable link copied to clipboard:\n" + shareableLink))
    .catch(err => prompt("Copy this link:", shareableLink));
});

        const dataStr = JSON.stringify(appData);
        const encodedData = btoa(dataStr);
        const shareableLink = window.location.origin + window.location.pathname + "?data=" + encodeURIComponent(encodedData);
        navigator.clipboard.writeText(shareableLink)
          .then(() => alert("Shareable link copied to clipboard:\n" + shareableLink))
          .catch(err => prompt("Copy this link:", shareableLink));
      });

      // Liked List Share using LZ-String compression
      btnShareLiked.addEventListener("click", () => {
        const dataStr = JSON.stringify(liked);
        const compressed = LZString.compressToEncodedURIComponent(dataStr);
        const shareableLink = window.location.origin + window.location.pathname + "?likeddata=" + compressed;
        navigator.clipboard.writeText(shareableLink)
          .then(() => alert("Shareable Liked List link copied to clipboard:\n" + shareableLink))
          .catch(err => prompt("Copy this link:", shareableLink));
      });

      nightModeToggle.addEventListener("click", () => {
        document.body.classList.toggle("night-mode");
        nightModeToggle.textContent = document.body.classList.contains("night-mode") ? "â˜€ï¸" : "ðŸŒ™";
      });
    });

    /* TAB SWITCHING */
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        contents.forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        const contentId = "content-" + tab.id.split("-")[1];
        document.getElementById(contentId).classList.add("active");
        if (tab.id === "tab-inventory" || tab.id === "tab-inout" || tab.id === "tab-liked") {
          renderCategoryTabs();
          updateInventoryDisplay();
          updateInOutCategories();
          updateInOutItems();
          if (tab.id === "tab-liked") {
            renderLiked();
          }
        }
      });
    });

    /* INITIALIZE APP */
    function initializeApp() {
      renderCategoryTabs();
      updateInOutCategories();
      updateInOutItems();
      updateInventoryDisplay();
    }

    /* EXPORT FUNCTIONS */
    function exportCSV(data, filename) {
      if (!data || !data.length) {
        alert("No data to export.");
        return;
      }
      const header = ["ID", "Name", "Category", "Quantity", "Image", "Backup"];
      const csvRows = [header.join(",")];
      data.forEach(item => {
        const row = [
          item.id,
          `"${item.name.replace(/"/g, '""')}"`,
          `"${item.category.replace(/"/g, '""')}"`,
          item.quantity,
          `"${item.image}"`,
          item.backup ? `"${item.backup}"` : ""
        ];
        csvRows.push(row.join(","));
      });
      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
    btnExportInventory.addEventListener("click", () => {
      let exportData = activeCategoryTab === "All" ? inventory : inventory.filter(item => item.category === activeCategoryTab);
      exportCSV(exportData, "inventory_export.csv");
    });
    btnExportLiked.addEventListener("click", () => {
      exportCSV(liked, "liked_export.csv");
    });

    /* INVENTORY TAB CONTROL PANEL */
    inventorySearchInput.addEventListener("input", (e) => {
      inventorySearchTerm = e.target.value.toLowerCase().trim();
      updateInventoryDisplay();
    });
    inventorySortSelect.addEventListener("change", (e) => {
      inventorySortOption = e.target.value;
      updateInventoryDisplay();
    });
    if (inventoryViewCardsBtn && inventoryViewListBtn) {
      inventoryViewCardsBtn.addEventListener("click", () => {
        inventoryViewType = "cards";
        inventoryViewCardsBtn.classList.add("active");
        inventoryViewListBtn.classList.remove("active");
        updateInventoryDisplay();
      });
      inventoryViewListBtn.addEventListener("click", () => {
        inventoryViewType = "list";
        inventoryViewListBtn.classList.add("active");
        inventoryViewCardsBtn.classList.remove("active");
        updateInventoryDisplay();
      });
    }
    if (likedViewCardsBtn && likedViewListBtn) {
      likedViewCardsBtn.addEventListener("click", () => {
        likedViewType = "cards";
        likedViewCardsBtn.classList.add("active");
        likedViewListBtn.classList.remove("active");
        renderLiked();
      });
      likedViewListBtn.addEventListener("click", () => {
        likedViewType = "list";
        likedViewListBtn.classList.add("active");
        likedViewCardsBtn.classList.remove("active");
        renderLiked();
      });
    }

    /* RENDER CATEGORY TABS */
    function renderCategoryTabs() {
      categoryTabsDiv.innerHTML = "";
      const allTab = document.createElement("div");
      allTab.className = "category-tab" + (activeCategoryTab === "All" ? " active" : "");
      allTab.textContent = "All";
      allTab.addEventListener("click", () => {
        activeCategoryTab = "All";
        renderCategoryTabs();
        updateInventoryDisplay();
      });
      categoryTabsDiv.appendChild(allTab);
      const categories = new Set(inventory.map(item => item.category));
      categories.forEach(cat => {
        const tab = document.createElement("div");
        tab.className = "category-tab" + (activeCategoryTab === cat ? " active" : "");
        tab.textContent = cat;
        tab.addEventListener("click", () => {
          activeCategoryTab = cat;
          renderCategoryTabs();
          updateInventoryDisplay();
        });
        categoryTabsDiv.appendChild(tab);
      });
    }

    /* UPDATE INVENTORY DISPLAY */
    function updateInventoryDisplay() {
      let items = inventory.filter(item =>
        item.name.toLowerCase().includes(inventorySearchTerm) ||
        item.category.toLowerCase().includes(inventorySearchTerm)
      );
      if (inventorySortOption === "name_asc") {
        items.sort((a, b) => a.name.localeCompare(b.name));
      } else if (inventorySortOption === "name_desc") {
        items.sort((a, b) => b.name.localeCompare(a.name));
      } else if (inventorySortOption === "qty_asc") {
        items.sort((a, b) => a.quantity - b.quantity);
      } else if (inventorySortOption === "qty_desc") {
        items.sort((a, b) => b.quantity - a.quantity);
      }
      if (activeCategoryTab !== "All") {
        items = items.filter(item => item.category === activeCategoryTab);
      }
      inventoryListDiv.innerHTML = "";
      if (items.length === 0) {
        inventoryListDiv.innerHTML = '<p class="error-message">No items in this category.</p>';
        return;
      }
      if (inventoryViewType === "cards") {
        items.forEach(item => {
          const card = document.createElement("div");
          card.className = "inventory-card";
          let html = "";
          if (item.image) {
            html += `<img src="${item.image}" alt="${item.name}">`;
          }
          html += `<h3>${item.name}</h3><p>Category: ${item.category}</p><p>Quantity: ${item.quantity}</p>`;
          card.innerHTML = html;
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "card-actions";
          if (!sharedMode) {
            const editBtn = document.createElement("button");
            editBtn.textContent = "âœï¸";
            editBtn.title = "Edit Item";
            editBtn.addEventListener("click", () => openEditModal(item.id));
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "ðŸ—‘ï¸";
            removeBtn.title = "Remove Item";
            removeBtn.addEventListener("click", () => {
              logEvent(`Item deleted: ${item.name}`);
              openConfirmModal(item.id, item.name);
            });
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(removeBtn);
          }
          const likedBtn = document.createElement("button");
          likedBtn.textContent = isItemLiked(item.id) ? "â¤ï¸" : "ðŸ¤";
          likedBtn.title = "Toggle Like";
          likedBtn.addEventListener("click", () => toggleLike(item.id, likedBtn));
          actionsDiv.appendChild(likedBtn);
          card.insertAdjacentElement("afterbegin", actionsDiv);
          inventoryListDiv.appendChild(card);
        });
      } else {
        const listContainer = document.createElement("div");
        listContainer.className = "list-view";
        items.forEach(item => {
          const row = document.createElement("div");
          row.className = "item-row";
          const infoDiv = document.createElement("div");
          infoDiv.className = "item-info";
          infoDiv.innerHTML = `<strong>${item.name}</strong> - ${item.category} (Qty: ${item.quantity})`;
          row.appendChild(infoDiv);
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "item-actions";
          if (!sharedMode) {
            const editBtn = document.createElement("button");
            editBtn.textContent = "âœï¸";
            editBtn.title = "Edit Item";
            editBtn.addEventListener("click", () => openEditModal(item.id));
            actionsDiv.appendChild(editBtn);
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "ðŸ—‘ï¸";
            removeBtn.title = "Remove Item";
            removeBtn.addEventListener("click", () => {
              logEvent(`Item deleted: ${item.name}`);
              openConfirmModal(item.id, item.name);
            });
            actionsDiv.appendChild(removeBtn);
          }
          const likedBtn = document.createElement("button");
          likedBtn.textContent = isItemLiked(item.id) ? "â¤ï¸" : "ðŸ¤";
          likedBtn.title = "Toggle Like";
          likedBtn.addEventListener("click", () => toggleLike(item.id, likedBtn));
          actionsDiv.appendChild(likedBtn);
          row.appendChild(actionsDiv);
          listContainer.appendChild(row);
        });
        inventoryListDiv.appendChild(listContainer);
      }
      saveData();
    }
    function isItemLiked(itemId) {
      return liked.some(i => i.id === itemId);
    }
    function toggleLike(itemId, btn) {
      if (isItemLiked(itemId)) {
        liked = liked.filter(i => i.id !== itemId);
        btn.classList.add("unliked-animation");
        setTimeout(() => {
          btn.classList.remove("unliked-animation");
          btn.textContent = "ðŸ¤";
        }, 300);
      } else {
        const item = inventory.find(i => i.id === itemId);
        if (!item) return;
        liked.push({ id: item.id, name: item.name, category: item.category, image: item.image, quantity: 1 });
        btn.textContent = "â¤ï¸";
        btn.classList.add("liked-animation");
        setTimeout(() => {
          btn.classList.remove("liked-animation");
        }, 300);
      }
      renderLiked();
      saveData();
    }

    /* RENDER LIKED ITEMS */
    function renderLiked() {
      likedListDiv.innerHTML = "";
      if (liked.length === 0) {
        likedListDiv.innerHTML = '<p class="error-message">You have not liked any items yet.</p>';
        return;
      }
      if (likedViewType === "cards") {
        liked.forEach(item => {
          const likedDiv = document.createElement("div");
          likedDiv.className = "liked-item";
          let html = "";
          if (item.image) {
            html += `<img src="${item.image}" alt="${item.name}" style="width:60px; height:60px; object-fit:cover; border-radius:8px; margin-right:10px;">`;
          }
          html += `<strong>${item.name}</strong> (${item.category}) - Quantity: ${item.quantity}`;
          likedDiv.innerHTML = html;
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            liked = liked.filter(i => i.id !== item.id);
            renderLiked();
            saveData();
          });
          likedDiv.appendChild(removeBtn);
          likedListDiv.appendChild(likedDiv);
        });
      } else {
        const listContainer = document.createElement("div");
        listContainer.className = "list-view";
        liked.forEach(item => {
          const row = document.createElement("div");
          row.className = "item-row";
          const infoDiv = document.createElement("div");
          infoDiv.className = "item-info";
          infoDiv.innerHTML = `<strong>${item.name}</strong> - ${item.category} (Qty: ${item.quantity})`;
          row.appendChild(infoDiv);
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "item-actions";
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.addEventListener("click", () => {
            liked = liked.filter(i => i.id !== item.id);
            renderLiked();
            saveData();
          });
          actionsDiv.appendChild(removeBtn);
          row.appendChild(actionsDiv);
          listContainer.appendChild(row);
        });
        likedListDiv.appendChild(listContainer);
      }
      saveData();
    }

    /* UPDATE IN/OUT ITEMS */
    function updateInOutCategories() {
      inoutCategorySelect.innerHTML = "";
      const categories = new Set(inventory.map(item => item.category));
      if (categories.size === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No categories available";
        inoutCategorySelect.appendChild(opt);
        return;
      }
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        inoutCategorySelect.appendChild(opt);
      });
      inoutCategorySelect.selectedIndex = 0;
      updateInOutItems();
    }
    function updateInOutItems() {
      inoutItemSelect.innerHTML = "";
      const selectedCategory = inoutCategorySelect.value;
      const items = inventory.filter(item => item.category === selectedCategory);
      if (items.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No items available";
        inoutItemSelect.appendChild(opt);
        return;
      }
      items.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = item.name;
        inoutItemSelect.appendChild(opt);
      });
    }
    inoutCategorySelect.addEventListener("change", updateInOutItems);
    btnAdd.addEventListener("click", () => {
      const itemId = parseInt(inoutItemSelect.value);
      const qty = parseInt(inoutQty.value);
      if (isNaN(itemId) || isNaN(qty) || qty < 1) return;
      const item = inventory.find(i => i.id === itemId);
      if (item) {
        item.quantity += qty;
        updateInventoryDisplay();
        logEvent(`In: Added ${qty} to ${item.name}`);
        saveData();
      }
    });
    btnRemove.addEventListener("click", () => {
      const itemId = parseInt(inoutItemSelect.value);
      const qty = parseInt(inoutQty.value);
      if (isNaN(itemId) || isNaN(qty) || qty < 1) return;
      const item = inventory.find(i => i.id === itemId);
      if (item) {
        item.quantity = Math.max(0, item.quantity - qty);
        updateInventoryDisplay();
        logEvent(`Out: Removed ${qty} from ${item.name}`);
        saveData();
      }
    });

    /* NEW ITEM: CUSTOM DROPDOWN SUGGESTIONS */
    function showSuggestions(inputEl, suggestionsDiv, list) {
      const value = inputEl.value.toLowerCase().trim();
      suggestionsDiv.innerHTML = "";
      if (!value) {
        suggestionsDiv.style.display = "none";
        return;
      }
      const filtered = list.filter(item => item.toLowerCase().includes(value));
      if (filtered.length === 0) {
        suggestionsDiv.style.display = "none";
        return;
      }
      filtered.forEach(suggestion => {
        const div = document.createElement("div");
        div.className = "suggestion";
        div.textContent = suggestion;
        div.addEventListener("click", () => {
          inputEl.value = suggestion;
          suggestionsDiv.innerHTML = "";
          suggestionsDiv.style.display = "none";
        });
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.style.display = "block";
    }
    function updateNameSuggestions() {
      const names = Array.from(new Set(inventory.map(item => item.name)));
      showSuggestions(newNameInput, nameSuggestionsDiv, names);
    }
    function updateCategorySuggestions() {
      const categories = Array.from(new Set(inventory.map(item => item.category)));
      showSuggestions(newCategoryInput, categorySuggestionsDiv, categories);
    }
    newNameInput.addEventListener("input", updateNameSuggestions);
    newCategoryInput.addEventListener("input", updateCategorySuggestions);

    /* NEW ITEM: ADD NEW ITEM */
    btnNewAdd.addEventListener("click", () => {
      const nameVal = newNameInput.value.trim();
      const catVal = newCategoryInput.value.trim();
      const qtyVal = parseInt(newQtyInput.value);
      if (nameVal === "" || catVal === "" || isNaN(qtyVal) || qtyVal < 1) {
        alert("Please fill in all fields correctly.");
        return;
      }
      if (inventory.some(item => item.name.toLowerCase() === nameVal.toLowerCase())) {
        alert("An item with that name already exists.");
        return;
      }
      const file = newImageInput.files[0];
      const addItemToLocal = (displayUrl, backupData) => {
        const newItem = { id: nextId++, name: nameVal, category: catVal, quantity: qtyVal, image: displayUrl, backup: backupData || null };
        inventory.push(newItem);
        logEvent(`New item added: ${nameVal}`);
        // Reset New Item form and clear search/filters
        newNameInput.value = "";
        newCategoryInput.value = "";
        newQtyInput.value = "1";
        newImageInput.value = "";
        inventorySearchInput.value = "";
        inventorySearchTerm = "";
        activeCategoryTab = "All";
        renderCategoryTabs();
        updateInventoryDisplay();
        updateInOutCategories();
        updateInOutItems();
        document.getElementById("tab-inventory").click();
        saveData();
      };
      if (file) {
        uploadImageToImgbb(file)
          .then(result => {
            addItemToLocal(result.display_url, result.backup_data);
          })
          .catch(err => {
            alert("Image upload failed.");
            console.error(err);
          });
      } else {
        addItemToLocal("", "");
      }
    });

    /* CONFIRMATION MODAL */
    function openConfirmModal(itemId, itemName) {
      currentRemoveId = itemId;
      confirmMessage.textContent = `Are you sure you want to remove "${itemName}"?`;
      confirmModal.classList.add("active");
    }
    confirmOk.addEventListener("click", () => {
      if (currentRemoveId !== null) {
        const removedItem = inventory.find(i => i.id === currentRemoveId);
        if (removedItem) {
          logEvent(`Item deleted: ${removedItem.name}`);
        }
        inventory = inventory.filter(i => i.id !== currentRemoveId);
        updateInventoryDisplay();
        updateInOutCategories();
        updateInOutItems();
        currentRemoveId = null;
        saveData();
      }
      confirmModal.classList.remove("active");
    });
    confirmCancel.addEventListener("click", () => {
      currentRemoveId = null;
      confirmModal.classList.remove("active");
    });

    /* EDIT MODAL */
    function openEditModal(itemId) {
      currentEditId = itemId;
      const item = inventory.find(i => i.id === itemId);
      if (!item) return;
      editName.value = item.name;
      editCategory.value = item.category;
      editModal.classList.add("active");
    }
    editSave.addEventListener("click", () => {
      const newNameVal = editName.value.trim();
      const newCatVal = editCategory.value.trim();
      if (newNameVal === "" || newCatVal === "") {
        alert("Please fill in all fields correctly.");
        return;
      }
      const item = inventory.find(i => i.id === currentEditId);
      if (item) {
        const oldName = item.name;
        item.name = newNameVal;
        item.category = newCatVal;
        if (oldName !== newNameVal) {
          logEvent(`Item updated: ${oldName} â†’ ${newNameVal}`);
        }
      }
      editModal.classList.remove("active");
      currentEditId = null;
      renderCategoryTabs();
      updateInventoryDisplay();
      updateInOutCategories();
      updateInOutItems();
      saveData();
    });
    editCancel.addEventListener("click", () => {
      currentEditId = null;
      editModal.classList.remove("active");
    });

    /* IMAGE UPLOAD FUNCTION */
    function uploadImageToImgbb(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const fullDataUrl = e.target.result; // backup data URL
          const base64 = fullDataUrl.split(",")[1];
          try {
            const formData = new URLSearchParams();
            formData.append("key", "3f1b77bcc1d4b241c00c5c3f27216041");
            formData.append("image", base64);
            const response = await fetch("https://api.imgbb.com/1/upload", {
              method: "POST",
              body: formData
            });
            const result = await response.json();
            if (result.success) {
              resolve({ display_url: result.data.display_url, backup_data: fullDataUrl });
            } else {
              reject(result.error);
            }
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /* SHARED DATA (if any) */
    function loadSharedData() {
      const params = new URLSearchParams(window.location.search);
      const likedDataParam = params.get("likeddata");
      const dataParam = params.get("data");
      if (likedDataParam) {
        try {
          // Decompress liked data using LZ-String
          const decompressed = LZString.decompressFromEncodedURIComponent(likedDataParam);
          const sharedLiked = JSON.parse(decompressed);
          if (Array.isArray(sharedLiked)) {
            liked = sharedLiked;
            document.getElementById("tab-inventory").style.display = "none";
            document.getElementById("tab-inout").style.display = "none";
            document.getElementById("tab-new").style.display = "none";
            document.getElementById("content-inventory").style.display = "none";
            document.getElementById("content-inout").style.display = "none";
            document.getElementById("content-new").style.display = "none";
            document.getElementById("tab-liked").click();
            return true;
          }
        } catch (err) {
          console.error("Error decoding shared liked data:", err);
        }
      }
      if (dataParam) {
        try {
          const decoded = atob(dataParam);
          const sharedData = JSON.parse(decoded);
          if (sharedData.inventory && Array.isArray(sharedData.inventory)) {
            inventory = sharedData.inventory;
            nextId = inventory.reduce((max, item) => Math.max(max, item.id), 0) + 1;
            if (sharedData.liked) liked = sharedData.liked;
            if (sharedData.historyLog) {
              historyLog = sharedData.historyLog;
              updateHistoryDisplay();
            }
            sharedMode = true;
            document.getElementById("tab-inout").style.display = "none";
            document.getElementById("tab-new").style.display = "none";
            document.getElementById("content-inout").style.display = "none";
            document.getElementById("content-new").style.display = "none";
            document.getElementById("tab-inventory").click();
            return true;
          }
        } catch (err) {
          console.error("Error decoding shared inventory:", err);
        }
      }
      return false;
    }

    /* DOMContentLoaded */
    document.addEventListener("DOMContentLoaded", () => {
      initializeApp();
      loadSharedData();
    });
  </script>
</body>
</html>
